name: "Build Plugin"
description: "Builds the plugin, prepares the artifact to publish"

runs:
  using: composite
  steps:

    # - name: Checkout the plugin GitHub repository
    #   uses: actions/checkout@v4

    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v2

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: zulu
        java-version: 11

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-home-cache-cleanup: true

    - name: Check repository content
      shell: bash
      run: pwd && ls -la

    - name: Fetch Gradle properties
      id: properties
      env:
        AUTO_SNAPSHOT_VERSION: false
      shell: bash
      run: |
        PROPERTIES="$(./gradlew properties --console=plain -q)"

        echo "pluginVerifierHomeDir=~/.pluginVerifier" >> $GITHUB_OUTPUT

        # prepare list of IDEs to use by plugin verifier:
        ./gradlew listProductsReleases

    - name: Build plugin
      shell: bash
      run: ./gradlew buildPlugin

    - name: Prepare Plugin Artifact
      id: artifact
      shell: bash
      run: |
        cd ${{ github.workspace }}/build/distributions
        FILENAME=`ls *.zip`
        unzip "$FILENAME" -d content
        echo "filename=${FILENAME:0:-4}" >> $GITHUB_OUTPUT
        echo "zip artifact name:"
        echo "$FILENAME"

    - name: Publish built plugin to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.filename }}
        path: ./build/distributions/content/*/*
